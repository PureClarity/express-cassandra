'use strict';

var Promise = require('bluebird');
var tryRequire = require('try-require');

var dseDriver = tryRequire('dse-driver');

var readdirp = require('readdirp');
var util = require('util');
var async = require('async');
var _ = require('lodash');

var cql = Promise.promisifyAll(dseDriver || require('cassandra-driver'));
var ORM = Promise.promisifyAll(require('./orm/apollo'));
var debug = require('debug')('express-cassandra');

var CassandraClient = function f(options) {
  var self = this;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
};

CassandraClient.createClient = function (options) {
  return new CassandraClient(options);
};

CassandraClient.setDirectory = function (directory) {
  CassandraClient.directory = directory;
  return CassandraClient;
};

CassandraClient.bind = function (options, cb) {
  var self = CassandraClient;
  self.modelInstance = {};
  self.orm = new ORM(options.clientOptions, options.ormOptions);
  self.orm.connect(function (err) {
    if (err) {
      if (cb) cb(err);
      return;
    }

    readdirp({
      root: self.directory,
      fileFilter: ['*.js', '*.javascript', '*.jsx', '*.coffee', '*.coffeescript', '*.iced', '*.script', '*.ts', '*.tsx', '*.typescript', '*.cjsx', '*.co', '*.json', '*.json5', '*.litcoffee', '*.liticed', '*.ls', '*.node', '*.toml', '*.wisp']
    }, function (err1, list) {
      if (err1 && err1.length > 0) {
        if (cb) cb(err1[0]);
        return;
      }

      list = list.files;

      async.each(list, function (file, callback) {
        if (file.name.indexOf('Model') === -1) {
          callback();
          return;
        }

        var modelName = self._translateFileNameToModelName(file.name);

        if (modelName) {
          var filePath = util.format('%s/%s', self.directory, file.path);
          // eslint-disable-next-line import/no-dynamic-require
          var modelSchema = require(filePath);
          self.modelInstance[modelName] = self.orm.add_model(modelName.toLowerCase(), modelSchema, function (err2) {
            if (err2) callback(err2);else callback();
          });
          self.modelInstance[modelName] = Promise.promisifyAll(self.modelInstance[modelName]);
        } else {
          callback();
        }
      }, function (err3) {
        if (err3 && cb) {
          cb(err3);
        } else if (cb) {
          cb();
        }
      });
    });
  });
};

CassandraClient.bindAsync = Promise.promisify(CassandraClient.bind);

CassandraClient.prototype.connect = function f(callback) {
  var self = this;
  self.orm.connect(callback);
};

CassandraClient.prototype.connectAsync = Promise.promisify(CassandraClient.prototype.connect);

CassandraClient.prototype.loadSchema = function f(modelName, modelSchema, callback) {
  var self = this;
  var cb = function cb(err) {
    if (typeof callback === 'function') {
      if (err) callback(err);else callback(null, self.modelInstance[modelName]);
    }
  };
  self.modelInstance[modelName] = self.orm.add_model(modelName, modelSchema, cb);
  self.modelInstance[modelName] = Promise.promisifyAll(self.modelInstance[modelName]);
  return self.modelInstance[modelName];
};

CassandraClient.prototype.loadSchemaAsync = function f(modelName, modelSchema) {
  var _this = this;

  return new Promise(function (resolve, reject) {
    _this.loadSchema(modelName, modelSchema, function (err, Model) {
      if (err) reject(err);else resolve(Model);
    });
  });
};

CassandraClient.uuid = function () {
  return cql.types.Uuid.random();
};

CassandraClient.uuidFromString = function (str) {
  return cql.types.Uuid.fromString(str);
};

CassandraClient.uuidFromBuffer = function (buf) {
  return new cql.types.Uuid(buf);
};

CassandraClient.timeuuid = function () {
  return cql.types.TimeUuid.now();
};

CassandraClient.timeuuidFromDate = function (date) {
  return cql.types.TimeUuid.fromDate(date);
};

CassandraClient.timeuuidFromString = function (str) {
  return cql.types.TimeUuid.fromString(str);
};

CassandraClient.timeuuidFromBuffer = function (buf) {
  return new cql.types.TimeUuid(buf);
};

CassandraClient.maxTimeuuid = function (date) {
  return cql.types.TimeUuid.max(date);
};

CassandraClient.minTimeuuid = function (date) {
  return cql.types.TimeUuid.min(date);
};

CassandraClient.prototype.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = {};
  }

  var defaults = {
    prepare: true
  };

  options = _.defaultsDeep(options, defaults);

  var randomModel = this.modelInstance[Object.keys(this.modelInstance)[0]];
  var builtQueries = [];
  var beforeHooks = [];
  for (var i = 0; i < queries.length; i++) {
    builtQueries.push({
      query: queries[i].query,
      params: queries[i].params
    });
    if (queries[i].before_hook) {
      var beforeHookAsync = Promise.promisify(queries[i].before_hook);
      beforeHooks.push(beforeHookAsync());
    }
  }

  var batchResult = void 0;
  Promise.all(beforeHooks).then(function () {
    if (builtQueries.length > 1) {
      return randomModel.execute_batchAsync(builtQueries, options);
    }
    if (builtQueries.length > 0) {
      debug('single query provided for batch request, applying as non batch query');
      return randomModel.execute_queryAsync(builtQueries[0].query, builtQueries[0].params, options);
    }
    debug('no queries provided for batch request, empty array found, doing nothing');
    return {};
  }).then(function (response) {
    batchResult = response;
    var afterHooks = [];
    for (var _i = 0; _i < queries.length; _i++) {
      if (queries[_i].after_hook) {
        var afterHookAsync = Promise.promisify(queries[_i].after_hook);
        afterHooks.push(afterHookAsync());
      }
    }
    return Promise.all(afterHooks);
  }).then(function () {
    callback(null, batchResult);
  }).catch(function (err) {
    callback(err);
  });
};

CassandraClient.prototype.doBatchAsync = Promise.promisify(CassandraClient.prototype.doBatch);

CassandraClient.doBatch = function f(queries, options, callback) {
  if (arguments.length === 2) {
    callback = options;
    options = {};
  }

  var defaults = {
    prepare: true
  };

  options = _.defaultsDeep(options, defaults);

  CassandraClient.prototype.doBatch.call(CassandraClient, queries, options, callback);
};

CassandraClient.doBatchAsync = Promise.promisify(CassandraClient.doBatch);

CassandraClient._translateFileNameToModelName = function (fileName) {
  return fileName.slice(0, fileName.lastIndexOf('.')).replace('Model', '');
};

Object.defineProperties(CassandraClient, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return CassandraClient.modelInstance;
    }
  },
  close: {
    get: function get() {
      return CassandraClient.orm.close;
    }
  },
  closeAsync: {
    get: function get() {
      return Promise.promisify(CassandraClient.orm.close);
    }
  }
});

Object.defineProperties(CassandraClient.prototype, {
  consistencies: {
    get: function get() {
      return cql.types.consistencies;
    }
  },
  datatypes: {
    get: function get() {
      return cql.types;
    }
  },
  driver: {
    get: function get() {
      return cql;
    }
  },
  instance: {
    get: function get() {
      return this.modelInstance;
    }
  },
  close: {
    get: function get() {
      return this.orm.close;
    }
  },
  closeAsync: {
    get: function get() {
      return Promise.promisify(this.orm.close);
    }
  }
});

CassandraClient.prototype.uuid = CassandraClient.uuid;
CassandraClient.prototype.uuidFromString = CassandraClient.uuidFromString;
CassandraClient.prototype.uuidFromBuffer = CassandraClient.uuidFromBuffer;
CassandraClient.prototype.timeuuid = CassandraClient.timeuuid;
CassandraClient.prototype.timeuuidFromDate = CassandraClient.timeuuidFromDate;
CassandraClient.prototype.timeuuidFromString = CassandraClient.timeuuidFromString;
CassandraClient.prototype.timeuuidFromBuffer = CassandraClient.timeuuidFromBuffer;
CassandraClient.prototype.maxTimeuuid = CassandraClient.maxTimeuuid;
CassandraClient.prototype.minTimeuuid = CassandraClient.minTimeuuid;

CassandraClient.prototype._translateFileNameToModelName = CassandraClient._translateFileNameToModelName;

module.exports = CassandraClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzQ2Fzc2FuZHJhLmpzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwidHJ5UmVxdWlyZSIsImRzZURyaXZlciIsInJlYWRkaXJwIiwidXRpbCIsImFzeW5jIiwiXyIsImNxbCIsInByb21pc2lmeUFsbCIsIk9STSIsImRlYnVnIiwiQ2Fzc2FuZHJhQ2xpZW50IiwiZiIsIm9wdGlvbnMiLCJzZWxmIiwibW9kZWxJbnN0YW5jZSIsIm9ybSIsImNsaWVudE9wdGlvbnMiLCJvcm1PcHRpb25zIiwiY3JlYXRlQ2xpZW50Iiwic2V0RGlyZWN0b3J5IiwiZGlyZWN0b3J5IiwiYmluZCIsImNiIiwiY29ubmVjdCIsImVyciIsInJvb3QiLCJmaWxlRmlsdGVyIiwiZXJyMSIsImxpc3QiLCJsZW5ndGgiLCJmaWxlcyIsImVhY2giLCJmaWxlIiwiY2FsbGJhY2siLCJuYW1lIiwiaW5kZXhPZiIsIm1vZGVsTmFtZSIsIl90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lIiwiZmlsZVBhdGgiLCJmb3JtYXQiLCJwYXRoIiwibW9kZWxTY2hlbWEiLCJhZGRfbW9kZWwiLCJ0b0xvd2VyQ2FzZSIsImVycjIiLCJlcnIzIiwiYmluZEFzeW5jIiwicHJvbWlzaWZ5IiwicHJvdG90eXBlIiwiY29ubmVjdEFzeW5jIiwibG9hZFNjaGVtYSIsImxvYWRTY2hlbWFBc3luYyIsInJlc29sdmUiLCJyZWplY3QiLCJNb2RlbCIsInV1aWQiLCJ0eXBlcyIsIlV1aWQiLCJyYW5kb20iLCJ1dWlkRnJvbVN0cmluZyIsInN0ciIsImZyb21TdHJpbmciLCJ1dWlkRnJvbUJ1ZmZlciIsImJ1ZiIsInRpbWV1dWlkIiwiVGltZVV1aWQiLCJub3ciLCJ0aW1ldXVpZEZyb21EYXRlIiwiZGF0ZSIsImZyb21EYXRlIiwidGltZXV1aWRGcm9tU3RyaW5nIiwidGltZXV1aWRGcm9tQnVmZmVyIiwibWF4VGltZXV1aWQiLCJtYXgiLCJtaW5UaW1ldXVpZCIsIm1pbiIsImRvQmF0Y2giLCJxdWVyaWVzIiwiYXJndW1lbnRzIiwiZGVmYXVsdHMiLCJwcmVwYXJlIiwiZGVmYXVsdHNEZWVwIiwicmFuZG9tTW9kZWwiLCJPYmplY3QiLCJrZXlzIiwiYnVpbHRRdWVyaWVzIiwiYmVmb3JlSG9va3MiLCJpIiwicHVzaCIsInF1ZXJ5IiwicGFyYW1zIiwiYmVmb3JlX2hvb2siLCJiZWZvcmVIb29rQXN5bmMiLCJiYXRjaFJlc3VsdCIsImFsbCIsInRoZW4iLCJleGVjdXRlX2JhdGNoQXN5bmMiLCJleGVjdXRlX3F1ZXJ5QXN5bmMiLCJyZXNwb25zZSIsImFmdGVySG9va3MiLCJhZnRlcl9ob29rIiwiYWZ0ZXJIb29rQXN5bmMiLCJjYXRjaCIsImRvQmF0Y2hBc3luYyIsImNhbGwiLCJmaWxlTmFtZSIsInNsaWNlIiwibGFzdEluZGV4T2YiLCJyZXBsYWNlIiwiZGVmaW5lUHJvcGVydGllcyIsImNvbnNpc3RlbmNpZXMiLCJnZXQiLCJkYXRhdHlwZXMiLCJkcml2ZXIiLCJpbnN0YW5jZSIsImNsb3NlIiwiY2xvc2VBc3luYyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsVUFBVUMsUUFBUSxVQUFSLENBQWhCO0FBQ0EsSUFBTUMsYUFBYUQsUUFBUSxhQUFSLENBQW5COztBQUVBLElBQU1FLFlBQVlELFdBQVcsWUFBWCxDQUFsQjs7QUFFQSxJQUFNRSxXQUFXSCxRQUFRLFVBQVIsQ0FBakI7QUFDQSxJQUFNSSxPQUFPSixRQUFRLE1BQVIsQ0FBYjtBQUNBLElBQU1LLFFBQVFMLFFBQVEsT0FBUixDQUFkO0FBQ0EsSUFBTU0sSUFBSU4sUUFBUSxRQUFSLENBQVY7O0FBRUEsSUFBTU8sTUFBTVIsUUFBUVMsWUFBUixDQUFxQk4sYUFBYUYsUUFBUSxrQkFBUixDQUFsQyxDQUFaO0FBQ0EsSUFBTVMsTUFBTVYsUUFBUVMsWUFBUixDQUFxQlIsUUFBUSxjQUFSLENBQXJCLENBQVo7QUFDQSxJQUFNVSxRQUFRVixRQUFRLE9BQVIsRUFBaUIsbUJBQWpCLENB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QUEwQlgsNkJBQTFCLEdBQTBEM0IsZ0JBQWdCMkIsNkJBQTFFOztBQUVBZ0YsT0FBT0MsT0FBUCxHQUFpQjVHLGVBQWpCIiwiZmlsZSI6ImV4cHJlc3NDYXNzYW5kcmEuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmNvbnN0IHRyeVJlcXVpcmUgPSByZXF1aXJlKCd0cnktcmVxdWlyZScpO1xuXG5jb25zdCBkc2VEcml2ZXIgPSB0cnlSZXF1aXJlKCdkc2UtZHJpdmVyJyk7XG5cbmNvbnN0IHJlYWRkaXJwID0gcmVxdWlyZSgncmVhZGRpcnAnKTtcbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5jb25zdCBhc3luYyA9IHJlcXVpcmUoJ2FzeW5jJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbmNvbnN0IGNxbCA9IFByb21pc2UucHJvbWlzaWZ5QWxsKGRzZURyaXZlciB8fCByZXF1aXJlKCdjYXNzYW5kcmEtZHJpdmVyJykpO1xuY29uc3QgT1JNID0gUHJvbWlzZS5wcm9taXNpZnlBbGwocmVxdWlyZSgnLi9vcm0vYXBvbGxvJykpO1xuY29uc3QgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpKCdleHByZXNzLWNhc3NhbmRyYScpO1xuXG5jb25zdCBDYXNzYW5kcmFDbGllbnQgPSBmdW5jdGlvbiBmKG9wdGlvbnMpIHtcbiAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gIHNlbGYubW9kZWxJbnN0YW5jZSA9IHt9O1xuICBzZWxmLm9ybSA9IG5ldyBPUk0ob3B0aW9ucy5jbGllbnRPcHRpb25zLCBvcHRpb25zLm9ybU9wdGlvbnMpO1xufTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmNyZWF0ZUNsaWVudCA9IChvcHRpb25zKSA9PiAobmV3IENhc3NhbmRyYUNsaWVudChvcHRpb25zKSk7XG5cbkNhc3NhbmRyYUNsaWVudC5zZXREaXJlY3RvcnkgPSAoZGlyZWN0b3J5KSA9PiB7XG4gIENhc3NhbmRyYUNsaWVudC5kaXJlY3RvcnkgPSBkaXJlY3Rvcnk7XG4gIHJldHVybiBDYXNzYW5kcmFDbGllbnQ7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQuYmluZCA9IChvcHRpb25zLCBjYikgPT4ge1xuICBjb25zdCBzZWxmID0gQ2Fzc2FuZHJhQ2xpZW50O1xuICBzZWxmLm1vZGVsSW5zdGFuY2UgPSB7fTtcbiAgc2VsZi5vcm0gPSBuZXcgT1JNKG9wdGlvbnMuY2xpZW50T3B0aW9ucywgb3B0aW9ucy5vcm1PcHRpb25zKTtcbiAgc2VsZi5vcm0uY29ubmVjdCgoZXJyKSA9PiB7XG4gICAgaWYgKGVycikge1xuICAgICAgaWYgKGNiKSBjYihlcnIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJlYWRkaXJwKHtcbiAgICAgIHJvb3Q6IHNlbGYuZGlyZWN0b3J5LFxuICAgICAgZmlsZUZpbHRlcjogW1xuICAgICAgICAnKi5qcycsICcqLmphdmFzY3JpcHQnLCAnKi5qc3gnLCAnKi5jb2ZmZWUnLCAnKi5jb2ZmZWVzY3JpcHQnLCAnKi5pY2VkJyxcbiAgICAgICAgJyouc2NyaXB0JywgJyoudHMnLCAnKi50c3gnLCAnKi50eXBlc2NyaXB0JywgJyouY2pzeCcsICcqLmNvJywgJyouanNvbicsXG4gICAgICAgICcqLmpzb241JywgJyoubGl0Y29mZmVlJywgJyoubGl0aWNlZCcsICcqLmxzJywgJyoubm9kZScsICcqLnRvbWwnLCAnKi53aXNwJyxcbiAgICAgIF0sXG4gICAgfSwgKGVycjEsIGxpc3QpID0+IHtcbiAgICAgIGlmIChlcnIxICYmIGVycjEubGVuZ3RoID4gMCkge1xuICAgICAgICBpZiAoY2IpIGNiKGVycjFbMF0pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxpc3QgPSBsaXN0LmZpbGVzO1xuXG4gICAgICBhc3luYy5lYWNoKGxpc3QsIChmaWxlLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBpZiAoZmlsZS5uYW1lLmluZGV4T2YoJ01vZGVsJykgPT09IC0xKSB7XG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtb2RlbE5hbWUgPSBzZWxmLl90cmFuc2xhdGVGaWxlTmFtZVRvTW9kZWxOYW1lKGZpbGUubmFtZSk7XG5cbiAgICAgICAgaWYgKG1vZGVsTmFtZSkge1xuICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gdXRpbC5mb3JtYXQoJyVzLyVzJywgc2VsZi5kaXJlY3RvcnksIGZpbGUucGF0aCk7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgICAgICBjb25zdCBtb2RlbFNjaGVtYSA9IHJlcXVpcmUoZmlsZVBhdGgpO1xuICAgICAgICAgIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gc2VsZi5vcm0uYWRkX21vZGVsKFxuICAgICAgICAgICAgbW9kZWxOYW1lLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICBtb2RlbFNjaGVtYSxcbiAgICAgICAgICAgIChlcnIyKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChlcnIyKSBjYWxsYmFjayhlcnIyKTtcbiAgICAgICAgICAgICAgZWxzZSBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICApO1xuICAgICAgICAgIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gUHJvbWlzZS5wcm9taXNpZnlBbGwoc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH0sIChlcnIzKSA9PiB7XG4gICAgICAgIGlmIChlcnIzICYmIGNiKSB7XG4gICAgICAgICAgY2IoZXJyMyk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2IpIHtcbiAgICAgICAgICBjYigpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5DYXNzYW5kcmFDbGllbnQuYmluZEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LmJpbmQpO1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmNvbm5lY3QgPSBmdW5jdGlvbiBmKGNhbGxiYWNrKSB7XG4gIGNvbnN0IHNlbGYgPSB0aGlzO1xuICBzZWxmLm9ybS5jb25uZWN0KGNhbGxiYWNrKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuY29ubmVjdEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5jb25uZWN0KTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5sb2FkU2NoZW1hID0gZnVuY3Rpb24gZihtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCBjYWxsYmFjaykge1xuICBjb25zdCBzZWxmID0gdGhpcztcbiAgY29uc3QgY2IgPSBmdW5jdGlvbiBjYihlcnIpIHtcbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBpZiAoZXJyKSBjYWxsYmFjayhlcnIpO1xuICAgICAgZWxzZSBjYWxsYmFjayhudWxsLCBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSk7XG4gICAgfVxuICB9O1xuICBzZWxmLm1vZGVsSW5zdGFuY2VbbW9kZWxOYW1lXSA9IHNlbGYub3JtLmFkZF9tb2RlbChtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCBjYik7XG4gIHNlbGYubW9kZWxJbnN0YW5jZVttb2RlbE5hbWVdID0gUHJvbWlzZS5wcm9taXNpZnlBbGwoc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV0pO1xuICByZXR1cm4gc2VsZi5tb2RlbEluc3RhbmNlW21vZGVsTmFtZV07XG59O1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmxvYWRTY2hlbWFBc3luYyA9IGZ1bmN0aW9uIGYobW9kZWxOYW1lLCBtb2RlbFNjaGVtYSkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHRoaXMubG9hZFNjaGVtYShtb2RlbE5hbWUsIG1vZGVsU2NoZW1hLCAoZXJyLCBNb2RlbCkgPT4ge1xuICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICBlbHNlIHJlc29sdmUoTW9kZWwpO1xuICAgIH0pO1xuICB9KTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC51dWlkID0gKCkgPT4gKGNxbC50eXBlcy5VdWlkLnJhbmRvbSgpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnV1aWRGcm9tU3RyaW5nID0gKHN0cikgPT4gKGNxbC50eXBlcy5VdWlkLmZyb21TdHJpbmcoc3RyKSk7XG5cbkNhc3NhbmRyYUNsaWVudC51dWlkRnJvbUJ1ZmZlciA9IChidWYpID0+IChuZXcgY3FsLnR5cGVzLlV1aWQoYnVmKSk7XG5cbkNhc3NhbmRyYUNsaWVudC50aW1ldXVpZCA9ICgpID0+IChjcWwudHlwZXMuVGltZVV1aWQubm93KCkpO1xuXG5DYXNzYW5kcmFDbGllbnQudGltZXV1aWRGcm9tRGF0ZSA9IChkYXRlKSA9PiAoY3FsLnR5cGVzLlRpbWVVdWlkLmZyb21EYXRlKGRhdGUpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbVN0cmluZyA9IChzdHIpID0+IChjcWwudHlwZXMuVGltZVV1aWQuZnJvbVN0cmluZyhzdHIpKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbUJ1ZmZlciA9IChidWYpID0+IChuZXcgY3FsLnR5cGVzLlRpbWVVdWlkKGJ1ZikpO1xuXG5DYXNzYW5kcmFDbGllbnQubWF4VGltZXV1aWQgPSAoZGF0ZSkgPT4gKGNxbC50eXBlcy5UaW1lVXVpZC5tYXgoZGF0ZSkpO1xuXG5DYXNzYW5kcmFDbGllbnQubWluVGltZXV1aWQgPSAoZGF0ZSkgPT4gKGNxbC50eXBlcy5UaW1lVXVpZC5taW4oZGF0ZSkpO1xuXG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmRvQmF0Y2ggPSBmdW5jdGlvbiBmKHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgIG9wdGlvbnMgPSB7fTtcbiAgfVxuXG4gIGNvbnN0IGRlZmF1bHRzID0ge1xuICAgIHByZXBhcmU6IHRydWUsXG4gIH07XG5cbiAgb3B0aW9ucyA9IF8uZGVmYXVsdHNEZWVwKG9wdGlvbnMsIGRlZmF1bHRzKTtcblxuICBjb25zdCByYW5kb21Nb2RlbCA9IHRoaXMubW9kZWxJbnN0YW5jZVtPYmplY3Qua2V5cyh0aGlzLm1vZGVsSW5zdGFuY2UpWzBdXTtcbiAgY29uc3QgYnVpbHRRdWVyaWVzID0gW107XG4gIGNvbnN0IGJlZm9yZUhvb2tzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcXVlcmllcy5sZW5ndGg7IGkrKykge1xuICAgIGJ1aWx0UXVlcmllcy5wdXNoKHtcbiAgICAgIHF1ZXJ5OiBxdWVyaWVzW2ldLnF1ZXJ5LFxuICAgICAgcGFyYW1zOiBxdWVyaWVzW2ldLnBhcmFtcyxcbiAgICB9KTtcbiAgICBpZiAocXVlcmllc1tpXS5iZWZvcmVfaG9vaykge1xuICAgICAgY29uc3QgYmVmb3JlSG9va0FzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkocXVlcmllc1tpXS5iZWZvcmVfaG9vayk7XG4gICAgICBiZWZvcmVIb29rcy5wdXNoKGJlZm9yZUhvb2tBc3luYygpKTtcbiAgICB9XG4gIH1cblxuICBsZXQgYmF0Y2hSZXN1bHQ7XG4gIFByb21pc2UuYWxsKGJlZm9yZUhvb2tzKVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIGlmIChidWlsdFF1ZXJpZXMubGVuZ3RoID4gMSkge1xuICAgICAgICByZXR1cm4gcmFuZG9tTW9kZWwuZXhlY3V0ZV9iYXRjaEFzeW5jKGJ1aWx0UXVlcmllcywgb3B0aW9ucyk7XG4gICAgICB9XG4gICAgICBpZiAoYnVpbHRRdWVyaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZGVidWcoJ3NpbmdsZSBxdWVyeSBwcm92aWRlZCBmb3IgYmF0Y2ggcmVxdWVzdCwgYXBwbHlpbmcgYXMgbm9uIGJhdGNoIHF1ZXJ5Jyk7XG4gICAgICAgIHJldHVybiByYW5kb21Nb2RlbC5leGVjdXRlX3F1ZXJ5QXN5bmMoYnVpbHRRdWVyaWVzWzBdLnF1ZXJ5LCBidWlsdFF1ZXJpZXNbMF0ucGFyYW1zLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICAgIGRlYnVnKCdubyBxdWVyaWVzIHByb3ZpZGVkIGZvciBiYXRjaCByZXF1ZXN0LCBlbXB0eSBhcnJheSBmb3VuZCwgZG9pbmcgbm90aGluZycpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH0pXG4gICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBiYXRjaFJlc3VsdCA9IHJlc3BvbnNlO1xuICAgICAgY29uc3QgYWZ0ZXJIb29rcyA9IFtdO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWVyaWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChxdWVyaWVzW2ldLmFmdGVyX2hvb2spIHtcbiAgICAgICAgICBjb25zdCBhZnRlckhvb2tBc3luYyA9IFByb21pc2UucHJvbWlzaWZ5KHF1ZXJpZXNbaV0uYWZ0ZXJfaG9vayk7XG4gICAgICAgICAgYWZ0ZXJIb29rcy5wdXNoKGFmdGVySG9va0FzeW5jKCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwoYWZ0ZXJIb29rcyk7XG4gICAgfSlcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCBiYXRjaFJlc3VsdCk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICB9KTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUuZG9CYXRjaEFzeW5jID0gUHJvbWlzZS5wcm9taXNpZnkoQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5kb0JhdGNoKTtcblxuQ2Fzc2FuZHJhQ2xpZW50LmRvQmF0Y2ggPSBmdW5jdGlvbiBmKHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgY2FsbGJhY2sgPSBvcHRpb25zO1xuICAgIG9wdGlvbnMgPSB7fTtcbiAgfVxuXG4gIGNvbnN0IGRlZmF1bHRzID0ge1xuICAgIHByZXBhcmU6IHRydWUsXG4gIH07XG5cbiAgb3B0aW9ucyA9IF8uZGVmYXVsdHNEZWVwKG9wdGlvbnMsIGRlZmF1bHRzKTtcblxuICBDYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLmRvQmF0Y2guY2FsbChDYXNzYW5kcmFDbGllbnQsIHF1ZXJpZXMsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbn07XG5cbkNhc3NhbmRyYUNsaWVudC5kb0JhdGNoQXN5bmMgPSBQcm9taXNlLnByb21pc2lmeShDYXNzYW5kcmFDbGllbnQuZG9CYXRjaCk7XG5cbkNhc3NhbmRyYUNsaWVudC5fdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZSA9IChmaWxlTmFtZSkgPT4gKFxuICBmaWxlTmFtZS5zbGljZSgwLCBmaWxlTmFtZS5sYXN0SW5kZXhPZignLicpKS5yZXBsYWNlKCdNb2RlbCcsICcnKVxuKTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ2Fzc2FuZHJhQ2xpZW50LCB7XG4gIGNvbnNpc3RlbmNpZXM6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsLnR5cGVzLmNvbnNpc3RlbmNpZXM7XG4gICAgfSxcbiAgfSxcbiAgZGF0YXR5cGVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcztcbiAgICB9LFxuICB9LFxuICBkcml2ZXI6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gY3FsO1xuICAgIH0sXG4gIH0sXG4gIGluc3RhbmNlOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIENhc3NhbmRyYUNsaWVudC5tb2RlbEluc3RhbmNlO1xuICAgIH0sXG4gIH0sXG4gIGNsb3NlOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIENhc3NhbmRyYUNsaWVudC5vcm0uY2xvc2U7XG4gICAgfSxcbiAgfSxcbiAgY2xvc2VBc3luYzoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShDYXNzYW5kcmFDbGllbnQub3JtLmNsb3NlKTtcbiAgICB9LFxuICB9LFxufSk7XG5cblxuT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZSwge1xuICBjb25zaXN0ZW5jaWVzOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbC50eXBlcy5jb25zaXN0ZW5jaWVzO1xuICAgIH0sXG4gIH0sXG4gIGRhdGF0eXBlczoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBjcWwudHlwZXM7XG4gICAgfSxcbiAgfSxcbiAgZHJpdmVyOiB7XG4gICAgZ2V0KCkge1xuICAgICAgcmV0dXJuIGNxbDtcbiAgICB9LFxuICB9LFxuICBpbnN0YW5jZToge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiB0aGlzLm1vZGVsSW5zdGFuY2U7XG4gICAgfSxcbiAgfSxcbiAgY2xvc2U6IHtcbiAgICBnZXQoKSB7XG4gICAgICByZXR1cm4gdGhpcy5vcm0uY2xvc2U7XG4gICAgfSxcbiAgfSxcbiAgY2xvc2VBc3luYzoge1xuICAgIGdldCgpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeSh0aGlzLm9ybS5jbG9zZSk7XG4gICAgfSxcbiAgfSxcbn0pO1xuXG5cbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudXVpZCA9IENhc3NhbmRyYUNsaWVudC51dWlkO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS51dWlkRnJvbVN0cmluZyA9IENhc3NhbmRyYUNsaWVudC51dWlkRnJvbVN0cmluZztcbkNhc3NhbmRyYUNsaWVudC5wcm90b3R5cGUudXVpZEZyb21CdWZmZXIgPSBDYXNzYW5kcmFDbGllbnQudXVpZEZyb21CdWZmZXI7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnRpbWV1dWlkID0gQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS50aW1ldXVpZEZyb21EYXRlID0gQ2Fzc2FuZHJhQ2xpZW50LnRpbWV1dWlkRnJvbURhdGU7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnRpbWV1dWlkRnJvbVN0cmluZyA9IENhc3NhbmRyYUNsaWVudC50aW1ldXVpZEZyb21TdHJpbmc7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLnRpbWV1dWlkRnJvbUJ1ZmZlciA9IENhc3NhbmRyYUNsaWVudC50aW1ldXVpZEZyb21CdWZmZXI7XG5DYXNzYW5kcmFDbGllbnQucHJvdG90eXBlLm1heFRpbWV1dWlkID0gQ2Fzc2FuZHJhQ2xpZW50Lm1heFRpbWV1dWlkO1xuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5taW5UaW1ldXVpZCA9IENhc3NhbmRyYUNsaWVudC5taW5UaW1ldXVpZDtcblxuQ2Fzc2FuZHJhQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZSA9IENhc3NhbmRyYUNsaWVudC5fdHJhbnNsYXRlRmlsZU5hbWVUb01vZGVsTmFtZTtcblxubW9kdWxlLmV4cG9ydHMgPSBDYXNzYW5kcmFDbGllbnQ7XG4iXX0=